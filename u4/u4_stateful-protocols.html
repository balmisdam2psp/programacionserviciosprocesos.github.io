<!DOCTYPE html><html><head>
      <title>UD4 Protocolos con estado</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css">
      
      
      
      
      
      <style>
      @import url(https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css);
code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}@font-face{font-family:"Material Icons";font-style:normal;font-weight:400;src:local("Material Icons"),local("MaterialIcons-Regular"),url("data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAAAfIAAsAAAAADDAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFZW7kosY21hcAAAAYAAAADTAAACjtP6ytBnbHlmAAACVAAAAxgAAAQ4zRtvlGhlYWQAAAVsAAAALwAAADYRwZsnaGhlYQAABZwAAAAcAAAAJAeKAzxobXR4AAAFuAAAABIAAAA8OGQAAGxvY2EAAAXMAAAAIAAAACAG5AfwbWF4cAAABewAAAAfAAAAIAEfAERuYW1lAAAGDAAAAVcAAAKFkAhoC3Bvc3QAAAdkAAAAYgAAAK2vz7wkeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkPsQ4gYGVgYOpk+kMAwNDP4RmfM1gxMjBwMDEwMrMgBUEpLmmMDgwVLy4xKzzX4chhrmK4QpQmBEkBwAZygyweJzFkr0NwjAQhZ+TEP6CRUfHBEwRUWaQTICyQbpMwRCskA5RUIONxG0RnnNpKAIV4qzPku/8c353ACYAYrIjCWCuMAh2ptf0/hiL3p/gyPUWa3osqlt0L1zu9r71z8dGrJRykFoauXQd932Lj5vhG+MjxGeYI8MKETObMpslf5EyP8tg+vHun5r539PvlvXzaVhRFVQDTPEWKVQR90KhnnC5Ek67vUKN4VuFasM/ldARj43CCkCsEjpJSoVVgRyU0GVSK6wUpFFCx8lFgX0BiXpRPQB4nE2TTWjcRhTH3xttpDhxN7uxPlp3u/FK7moRPixafRijNosxSw/LUsIwNcaEHPZggo/FmEKMCKWU4kNOOftQSlhE8alnH0Ix9BqWnHooPRrTQ0+mnu2bXTu2pPdGM9LM/6c3fwECTM4gBBMYQNqxzLrZAjqYSlqu2TAHZQA0/DQJH6FtzqGDnvbt4Ggwvzw/nL8EfH8kW0fsuRqhgWXZnY7M1picaUL7Du5BHeDzMIl83dAt016wH1qmvtSMo5R6YRJHTR//FXsff/nj/tc/5K9P5d+nP22+fFK5u7v3K39SW3y+OtDKO3L85vD09PD9z5X17a2N1g4tqk01RlqX7gyoEmnsWQtVr4rtZMmukEaFBZxzefkCn11cyKMLZgshRwgTYNoLNXCBz2ja7HvZG7hDpPSNfoo5vs0knK/9hb+rNpu+8kHPgk/Ao4kK3tWtTpSEtvkA9c+wE6UaUdwieNkaHg55tBEtRiEPw1s0+FtrtTcc9two2lhMknV7PZF/cs6+uUFTmpTGbEx7sQCPSLOttHS3GRltqp7SNzVSKzl6aWnZT/CX5k6/v9N3Hh8fHBwffJVjhrC6OgH5dkIt/tPsq+d/PD5Qz7G7efzq1THFjdZVPe/N6ulQ3JnDWSE5junsFsVIiFwL/htf1S5gJ3BfOcUxfHKLnzqpFpyfZ9cX+/5WB6a+Y0pHpzkNrYNVDwMsikK+y7WuLCRg/oFHkA8VT3rDg5ZnU6ktzzINymV0m74Xd5pfIGXyFeVEQSShkzqG7TBBa2OxVRKitLXv7h3uuftXnXq7lz2tZ/WnWa9dx9dCjDhHzmuVQATlmljr9dZErUydSo2Hbi/b1vXtrOeGCk2/8s3ZlO8+ueJT8BVlw5pGw2oYccdSiHHqx0RlabHqdNR9jAETl6PreJcPBnnfpTLnOQ8C3OV8AmQGzouV1iZdeb5SSIoVc8W8/kcDtksUH5FrU6/aqBqNWcMEzxG4DAQ14qRQhi9mWU0rzepKezbjfgCwQKxVYq5ajRgpRqy45CqwkJydcEkbTkvRz8P5/2ZpDTN4nGNgZGBgAOKb6v+/xvPbfGXgZmEAgeuB2kkI+v8bFgbmKiCXg4EJJAoAPyAKhQB4nGNgZGBg1vmvwxDDwgACQJKRARXwAwAzZQHQeJxjYQCCFAYGFgbSMQAcWACdAAAAAAAAAAwALgBgAIQAmADSAQgBIgE8AVABoAHeAfwCHHicY2BkYGDgZ7BgYGMAASYg5gJCBob/YD4DAA/hAWQAeJxlkbtuwkAURMc88gApQomUJoq0TdIQzEOpUDokKCNR0BuzBiO/tF6QSJcPyHflE9Klyyekz2CuG8cr7547M3d9JQO4xjccnJ57vid2cMHqxDWc40G4Tv1JuEF+Fm6ijRfhM+oz4Ra6eBVu4wZvvMFpXLIa40PYQQefwjVc4Uu4Tv1HuEH+FW7i1mkKn6Hj3Am3sHC6wm08Ou8tpSZGe1av1PKggjSxPd8zJtSGTuinyVGa6/Uu8kxZludCmzxMEzV0B6U004k25W35fj2yNlCBSWM1paujKFWZSbfat+7G2mzc7weiu34aczzFNYGBhgfLfcV6iQP3ACkSaj349AxXSN9IT0j16JepOb01doiKbNWt1ovippz6sVYYwsXgX2rGVFIkq7Pl2PNrI6qW6eOshj0xaSq9mpNEZIWs8LZUfOouNkVXxp/d5woqebeYIf4D2J1ywQB4nG3LOw6AIBAE0B384B+PAkgEa+QwNnYmHt+EpXSal5lkSBBnoP8oCFSo0aCFRIceA0ZMmLFAYSW88rmvtMUjG3RiQ9HvpfusM6zWNmtc5H/iPewha50tOt5PS/QBx2IeSwAA") format("woff")}.admonition{box-shadow:0 2px 2px 0 rgba(0,0,0,.14),0 1px 5px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.2);position:relative;margin:1.5625em 0;padding:0 1.2rem;border-left:.4rem solid rgba(68,138,255,.8);border-radius:.2rem;background-color:rgba(255,255,255,.05);overflow:auto}.admonition>p{margin-top:.8rem}.admonition>.admonition-title{margin:0 -1.2rem;padding:.8rem 1.2rem .8rem 3.6rem;border-bottom:1px solid rgba(68,138,255,.2);background-color:rgba(68,138,255,.1);font-weight:700}.admonition>.admonition-title:before{position:absolute;left:1.2rem;font-size:1.5rem;color:rgba(68,138,255,.8);content:"\E3C9"}.admonition>.admonition-title:before{font-family:Material Icons;font-style:normal;font-variant:normal;font-weight:400;line-height:2rem;text-transform:none;white-space:nowrap;speak:none;word-wrap:normal;direction:ltr}.admonition.abstract,.admonition.summary,.admonition.tldr{border-left-color:rgba(0,176,255,.8)}.admonition.abstract>.admonition-title,.admonition.summary>.admonition-title,.admonition.tldr>.admonition-title{background-color:rgba(0,176,255,.1);border-bottom-color:rgba(0,176,255,.2)}.admonition.abstract>.admonition-title:before,.admonition.summary>.admonition-title:before,.admonition.tldr>.admonition-title:before{color:#00b0ff;content:"\E8D2"}.admonition.hint,.admonition.tip{border-left-color:rgba(0,191,165,.8)}.admonition.hint>.admonition-title,.admonition.tip>.admonition-title{background-color:rgba(0,191,165,.1);border-bottom-color:rgba(0,191,165,.2)}.admonition.hint>.admonition-title:before,.admonition.tip>.admonition-title:before{color:#00bfa5;content:"\E80E"}.admonition.info,.admonition.todo{border-left-color:rgba(0,184,212,.8)}.admonition.info>.admonition-title,.admonition.todo>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.info>.admonition-title:before,.admonition.todo>.admonition-title:before{color:#00b8d4;content:"\E88E"}.admonition.check,.admonition.done,.admonition.success{border-left-color:rgba(0,200,83,.8)}.admonition.check>.admonition-title,.admonition.done>.admonition-title,.admonition.success>.admonition-title{background-color:rgba(0,200,83,.1);border-bottom-color:rgba(0,200,83,.2)}.admonition.check>.admonition-title:before,.admonition.done>.admonition-title:before,.admonition.success>.admonition-title:before{color:#00c853;content:"\E876"}.admonition.faq,.admonition.help,.admonition.question{border-left-color:rgba(100,221,23,.8)}.admonition.faq>.admonition-title,.admonition.help>.admonition-title,.admonition.question>.admonition-title{background-color:rgba(100,221,23,.1);border-bottom-color:rgba(100,221,23,.2)}.admonition.faq>.admonition-title:before,.admonition.help>.admonition-title:before,.admonition.question>.admonition-title:before{color:#64dd17;content:"\E887"}.admonition.attention,.admonition.caution,.admonition.warning{border-left-color:rgba(255,145,0,.8)}.admonition.attention>.admonition-title,.admonition.caution>.admonition-title,.admonition.warning>.admonition-title{background-color:rgba(255,145,0,.1);border-bottom-color:rgba(255,145,0,.2)}.admonition.attention>.admonition-title:before{color:#ff9100;content:"\E417"}.admonition.caution>.admonition-title:before,.admonition.warning>.admonition-title:before{color:#ff9100;content:"\E002"}.admonition.fail,.admonition.failure,.admonition.missing{border-left-color:rgba(255,82,82,.8)}.admonition.fail>.admonition-title,.admonition.failure>.admonition-title,.admonition.missing>.admonition-title{background-color:rgba(255,82,82,.1);border-bottom-color:rgba(255,82,82,.2)}.admonition.fail>.admonition-title:before,.admonition.failure>.admonition-title:before,.admonition.missing>.admonition-title:before{color:#ff5252;content:"\E14C"}.admonition.bug,.admonition.danger,.admonition.error{border-left-color:rgba(255,23,68,.8)}.admonition.bug>.admonition-title,.admonition.danger>.admonition-title,.admonition.error>.admonition-title{background-color:rgba(255,23,68,.1);border-bottom-color:rgba(255,23,68,.2)}.admonition.danger>.admonition-title:before{color:#ff1744;content:"\E3E7"}.admonition.error>.admonition-title:before{color:#ff1744;content:"\E14C"}.admonition.bug>.admonition-title:before{color:#ff1744;content:"\E868"}.admonition.example,.admonition.snippet{border-left-color:rgba(0,184,212,.8)}.admonition.example>.admonition-title,.admonition.snippet>.admonition-title{background-color:rgba(0,184,212,.1);border-bottom-color:rgba(0,184,212,.2)}.admonition.example>.admonition-title:before,.admonition.snippet>.admonition-title:before{color:#00b8d4;content:"\E242"}.admonition.cite,.admonition.quote{border-left-color:rgba(158,158,158,.8)}.admonition.cite>.admonition-title,.admonition.quote>.admonition-title{background-color:rgba(158,158,158,.1);border-bottom-color:rgba(158,158,158,.2)}.admonition.cite>.admonition-title:before,.admonition.quote>.admonition-title:before{color:#9e9e9e;content:"\E244"}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

@font-face {
  font-family: 'Catamaran';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/catamaran/v27/o-0bIpQoyXQa2RxT7-5B6Ryxs2E_6n1iPHjd5a7dvg.ttf) format('truetype');
}
.markdown-preview.markdown-preview .box_bg_lightgrey {
  background-color: #f5f5f5;
  border: 2px solid #969696;
  padding: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .box_bg_lightgreen {
  background-color: #f5faf5;
  border: 2px solid #969b96;
  padding-left: 15px;
  padding-right: 15px;
  margin-top: 15px;
  margin-bottom: 15px;
  border-radius: 5px;
  box-shadow: 0 0 7px 0 rgba(78, 120, 158, 0.1);
}
.markdown-preview.markdown-preview .contenedor {
  display: flex;
  justify-content: center;
  margin: 30px auto 30px auto;
}
.markdown-preview.markdown-preview .fondo {
  background: url(https://balmisdigigs.github.io/digitalizacion.github.io/imagenes/fondos/quote.png);
  background-size: cover;
  width: 75%;
  height: 160px;
  border-radius: 10px;
  position: relative;
}
.markdown-preview.markdown-preview .cita {
  font-family: Arial;
  font-style: italic;
  font-weight: 600;
  text-align: justify;
  line-height: 1.5rem;
  opacity: 0.6;
  color: white;
  padding: 5rem;
  position: relative;
  top: 50%;
  left: 50%;
  font-size: 1.3rem;
  transform: translate(-50%, -50%);
}
.markdown-preview.markdown-preview .abre_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-left: 30px;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, -15%);
}
.markdown-preview.markdown-preview .cierra_comilla {
  font-family: "Catamaran";
  font-weight: 600;
  color: white;
  padding-right: 30px;
  right: 0%;
  position: absolute;
  font-size: 6rem;
  transform: translate(0%, 55%);
}
.markdown-preview.markdown-preview .autor {
  font-family: Arial;
  color: white;
  margin: 0px;
  padding-left: 30px;
  position: absolute;
  top: 83%;
  font-size: 1rem;
}
.markdown-preview.markdown-preview .flotante {
  display: flex;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: center;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    justify-content: space-between;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante {
    flex-direction: row;
  }
}
.markdown-preview.markdown-preview .flotante_izq {
  margin-right: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_izq {
    width: auto;
  }
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: 100%;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .flotante_der {
    width: auto;
  }
}
.markdown-preview.markdown-preview .galeria_imagenes {
  display: flex;
  justify-content: space-evenly;
  align-items: center;
  margin-top: 15px;
  margin-bottom: 15px;
}
@media (max-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: column;
  }
}
@media (min-width: 550px) {
  .markdown-preview.markdown-preview .galeria_imagenes {
    flex-direction: row;
  }
}

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  const configureMermaidIconPacks = () => {
    window["mermaid"].registerIconPacks([
      {
        name: "logos",
        loader: () =>
          fetch("https://unpkg.com/@iconify-json/logos@1/icons.json").then(
            (res) => res.json()
          ),
      },
    ]);
  };

  if (document.readyState !== 'loading') {
    configureMermaidIconPacks();
  } else {
    document.addEventListener("DOMContentLoaded", () => {
      configureMermaidIconPacks();
    });
  }
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="unidad-4-programación-en-red-protocolos-con-estado">Unidad 4. Programación en red: Protocolos con estado </h1>
<p><a href="./u4_stateful-protocols.pdf">Descargar estos apuntes</a></p>
<h2 id="índice">Índice </h2>

<div class="md-toc">
<details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#protocolos-con-y-sin-estado" class="md-toc-link"><p>Protocolos con y sin estado</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#protocolos-sin-estado" class="md-toc-link">
            <p>Protocolos sin estado</p>

          </a></div><div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#protocolos-con-estado" class="md-toc-link">
            <p>Protocolos con estado</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#programación-de-servidores-basados-en-estados" class="md-toc-link"><p>Programación de servidores basados en estados</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#programación-de-aplicaciones-cliente-yo-servidor" class="md-toc-link">
            <p>Programación de aplicaciones Cliente y/o Servidor</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#ejemplo-de-servidor-con-estados" class="md-toc-link"><p>Ejemplo de servidor con estados</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ejemplo-del-worker-que-implementa-el-protocolo" class="md-toc-link">
            <p>Ejemplo del Worker que implementa el protocolo</p>

          </a></div>
        </div>
      </details>
    <details style="padding:0;;padding-left:0px;" open="">
        <summary class="md-toc-link-wrapper">
          <a href="#ejemplo-de-cliente-con-estados" class="md-toc-link"><p>Ejemplo de cliente con estados</p>
</a>
          </summary>
        <div>
          <div class="md-toc-link-wrapper" style="padding:0;;display:list-item;list-style:square;margin-left:42px">
          <a href="#ejemplo-de-cliente-genérico-que-implementa-el-protocolo" class="md-toc-link">
            <p>Ejemplo de cliente "genérico" que implementa el protocolo</p>

          </a></div>
        </div>
      </details>
    
</div>
<div style="page-break-after:always;"></div>
<h2 id="protocolos-con-y-sin-estado">Protocolos con y sin estado </h2>
<p>Como ya hemos comentado anteriormente, un protocolo, aplicado al mundo de las comunicaciones informáticas, es un conjunto de reglas que especifican la manera en la que se realiza la comunicación entre dos interlocutores.</p>
<p>Este conjunto de reglas establece el formato de los mensajes que se intercambian <code>(texto, binario, JSON, XML, CSV, ...)</code>, las acciones que cada uno de los extremos de la comunicación deben realizar en cada momento <code>(envío o recepción)</code> y, lo que nos ocupa en este apartado del tema, si las acciones dependen de acciones anteriores o no.</p>
<h3 id="protocolos-sin-estado">Protocolos sin estado </h3>
<p>En informática, un protocolo sin estado es un protocolo de comunicaciones que trata cada petición como una transacción independiente que no tiene relación con cualquier solicitud anterior, de modo que la comunicación se compone de pares independientes de solicitud y respuesta.<br>
<a href="https://es.wikipedia.org/wiki/Protocolo_sin_estado">Wikipedia: Protocolo sin estado</a></p>
<p>El ejemplo más conocido de protocolo sin estado es HTTP.1​ El protocolo no proporciona medio alguno de almacenamiento de datos de un usuario entre las peticiones, dejando esta tarea a niveles superiores y haciendo necesario el reenvío de información de manera continua para simular un funcionamiento con estado (cookies, cabeceras, etc.).</p>
<h3 id="protocolos-con-estado">Protocolos con estado </h3>
<p>Un protocolo sin estado no requiere que el servidor retenga información de la sesión o de estado acerca de los intercambios de información durante la realización de múltiples peticiones. En contraste, un protocolo que requiere el mantenimiento del <strong>estado interno en el servidor</strong> se conoce como un <strong>protocolo con estado</strong>.</p>
<p>Por lo tanto, un estado es una configuración en un programa o máquina que depende de los estados anteriores y que determina el funcionamiento del sistema, en función de la entrada recibida y del estado actual en el que se encuentre el sistema.</p>
<p>Poniendo una analogía, podemos tomar una solicitud a la administración, donde debemos realizar varios pasos hasta resolver la solicitud.</p>
<ol>
<li>En primer lugar se rellena una instancia con los datos y se envía al departamento correspondiente.</li>
<li>Ese departamento comprobará la instancia recibida y contestará solicitando información adicional o confirmando que la solicitud se ha recibido correctamente.</li>
<li>En un proceso posterior, se solicita un pago de tasas al usuario.</li>
<li>El usuario tiene que realizar el pago de tasas y enviar el justificante.</li>
<li>Tras cotejar toda la información, se le solicita al usuario que aporte los documentos originales.</li>
<li>El usuario se persona para mostrar la documentación original</li>
<li>Finalmente se resuelve la solicitud informando al usuario el resultado de la misma.</li>
</ol>
<p>Esto, que puede ser un procedimiento normal, refleja claramente un proceso en el que se siguen una serie de pasos y cuyo orden no se puede cambiar.</p>
<p>Por ejemplo, no tendría sentido hacer el pago de las tasas (paso 4) sin antes haber presentado la solicitud (paso 1) o sin haber recibido la confirmación de que la solicitud está completa.</p>
<p>Esto mismo pasa con algunos protocolos de comunicación.</p>
<h2 id="programación-de-servidores-basados-en-estados">Programación de servidores basados en estados </h2>
<p>Hay toda una teoría matemática, <code>la teoría de grafos</code>, desarrollada en torno a esto, junto con un modelo computacional, <code>los autómatas finitos</code>, que estudian y optimizan el desarrollo de aplicaciones basadas en estados.</p>
<p>La teoría de grafos es una rama de las matemáticas y las ciencias de la computación que estudia las propiedades de los grafos</p>
<p>La teoría de grafos tiene sus fundamentos en las <code>matemáticas discretas</code> y de las <code>matemáticas aplicadas</code>. Esta teoría requiere de diferentes conceptos de diversas áreas como <strong>combinatoria, álgebra, probabilidad, geometría de polígonos, aritmética y topología</strong>. Actualmente ha tenido mayor influencia en el campo de la informática, las ciencias de la computación y telecomunicaciones. Debido a la gran cantidad de aplicaciones en la optimización de recorridos, procesos, flujos y algoritmos de búsquedas, entre otros</p>
<p>Un autómata finito o máquina de estado finito es un modelo computacional que toma decisiones de computación de forma automática sobre una entrada para producir una salida.</p>
<p>Este modelo está conformado por un alfabeto, un conjunto de estados finito, una función de transición, un estado inicial y un conjunto de estados finales.</p>
<p>La finalidad de los autómatas finitos, entre otras, es la de reconocer lenguajes regulares, que corresponden a los lenguajes formales más simples según la Jerarquía de Chomsky.</p>
<h3 id="programación-de-aplicaciones-cliente-yo-servidor">Programación de aplicaciones Cliente y/o Servidor </h3>
<p>Como en todos los casos que hemos estudiado con anterioridad, el protocolo es la pieza común entre los clientes y los servidores.</p>
<p>Nuestros clientes podrán estar bien o mal programados, de hecho muchos de nuestros clientes son interactivos, por lo que podemos alterar el orden de los comandos a nuestro antojo, no siendo esto ningún problema.</p>
<p>Debe ser el servidor el que tenga el control del proceso, el que asegure la integridad del sistema y de los datos, por lo tanto va a ser en la parte del servidor donde tengamos que realizar las modificaciones para adaptarlo al control y gestión de los estados.</p>
<p>Esto no quita que los clientes deban seguir <code>sincronizados</code> con el servidor para evitar situaciones de interbloqueo, ya que de una forma u otra el cliente siempre debe seguir el protocolo, aunque no los estados tal y como hemos dicho.</p>
<h2 id="ejemplo-de-servidor-con-estados">Ejemplo de servidor con estados </h2>
<p>Vamos a ver qué pasos debemos seguir para controlar los estados en el servidor y cómo adaptar un cliente.</p>
<p>El ejemplo que vamos a utilizar es el de la actividad  <code>U4A03_ProtocoloSaludo</code>. Primero vamos a aclarar cómo debe funcionar este protocolo.</p>
<p>Si el cliente está bien programado, el intercambio de información entre Cliente y Servidor se realiza en tres pasos</p>
<ol>
<li>Cliente envía "Hi Server!"</li>
<li>Servidor responde "Hi Client!"</li>
<li>Cliente responde "By Server!"</li>
</ol>
<p>Ante un funcionamiento normal, este protocolo es bastante fácil de implementar. Sin embargo,</p>
<ul>
<li>¿Qué pasa si el cliente envía "By Server!" como primer mensaje?</li>
<li>¿Qué debe responder el servidor si no recibe el mensaje que está esperando?</li>
<li>¿Qué debe hacer el cliente si no recibe el mensaje que está esperando?</li>
</ul>
<p>Estas son las circunstancias a las que debemos responder con los estados del protocolo, indicando en cada caso qué debe hacer cada una de las partes. Todo dependerá de la funcionalidad que esté implementando el protocolo.</p>
<p>Cada caso es diferente, por ejemplo, si es importante hacer los tres pasos en orden, ante cualquier fallo se debe volver a empezar (un borrado en una BD, una autenticación de tres vías). Si por el contrario, los dos primeros pasos se tienen que realizar de forma conjunta, pero el tercero es independiente, si el incumplimiento del protocolo se produce en ese momento, no es necesario que se repitan los dos primeros pasos, sino que sólo será necesario repetir el último.</p>
<p><img src="./assets/imgs/sample_state_protocol.png" alt="Diagrama de estados U4A03_ProtocoloSaludo"></p>
<h3 id="ejemplo-del-worker-que-implementa-el-protocolo">Ejemplo del Worker que implementa el protocolo </h3>
<pre data-role="codeBlock" data-info="java{highlight=[12,17,34,50,61,71]}" class="language-java java" data-line="12,17,34,50,61,71"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">U4A03_SaludoWorker</span> <span class="token keyword keyword-extends">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>

    <span class="token class-name">Socket</span> socketCliente<span class="token punctuation">;</span>
    <span class="token class-name">BufferedReader</span> entrada<span class="token punctuation">;</span>
    <span class="token class-name">PrintWriter</span> salida<span class="token punctuation">;</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"Hi Server!"</span><span class="token punctuation">,</span> <span class="token string">"Hi Client!"</span><span class="token punctuation">,</span> <span class="token string">"Bye Server!"</span><span class="token punctuation">,</span> <span class="token string">"Error. Unknown or unexpected command"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-enum">enum</span> <span class="token class-name">Estados</span> <span class="token punctuation">{</span>
        <span class="token constant">HI</span><span class="token punctuation">,</span> <span class="token constant">BYE</span><span class="token punctuation">,</span> <span class="token constant">END</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Estados</span> estado<span class="token punctuation">;</span>

    <span class="token class-name">U4A03_SaludoWorker</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socketCliente<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>socketCliente <span class="token operator">=</span> socketCliente<span class="token punctuation">;</span>
        <span class="token comment">// Inicializamos el valor del estado al estado inicial</span>
        estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">HI</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-void">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// Establece canal de entrada</span>
            entrada <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-new">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>socketCliente<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Obtenemos el canal de salida</span>
            salida <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-new">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span>
                            <span class="token keyword keyword-new">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>socketCliente<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Recibe lo que envía el cliente hasta que el mensaje sea</span>
            <span class="token comment">// END OF TRANSMISSION</span>
            <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span>estado <span class="token operator">!=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">END</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Recibe la solicitud del cliente por el InputStream</span>
                <span class="token class-name">String</span> str <span class="token operator">=</span> entrada<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// Comprobamos si se ha cerrado el extremo cliente del socket</span>
                <span class="token comment">// Y damos por concluida la comunicación.</span>
                <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">END</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// Mostramos la información recibida por consola</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CLIENTE &gt; "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// Controlamos la respuesta en función del mensaje recibido y </span>
                <span class="token comment">// el estado actual</span>
                <span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>estado<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword keyword-case">case</span> <span class="token constant">HI</span><span class="token operator">:</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Enviamos respuesta al cliente</span>
                            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// Cambiamos el estado del protocolo</span>
                            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">BYE</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Enviamos error al cliente</span>
                            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token constant">BYE</span><span class="token operator">:</span>
                        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Cambiamos el estado del protocolo</span>
                            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">END</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                            <span class="token comment">// Enviamos error al cliente</span>
                            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">HI</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                    <span class="token keyword keyword-case">case</span> <span class="token constant">END</span><span class="token operator">:</span>
                        <span class="token comment">// No sería necesario contemplarlo en este caso</span>
                        <span class="token comment">// Pero sí en otros en los que se tenga que enviar </span>
                        <span class="token comment">// algún mensaje antes de salir.</span>
                        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error de comunicación con el cliente"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getLocalizedMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-finally">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
                entrada<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Conexión cerrada: "</span> <span class="token operator">+</span> socketCliente<span class="token punctuation">)</span><span class="token punctuation">;</span>
                socketCliente<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error inesperado cerrando los recursos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">










<div aria-hidden="true" class="line-highlight" data-range="12" data-start="12">
</div></div><div class="line-highlight-wrapper">















<div aria-hidden="true" class="line-highlight" data-range="17" data-start="17">
</div></div><div class="line-highlight-wrapper">
































<div aria-hidden="true" class="line-highlight" data-range="34" data-start="34">
</div></div><div class="line-highlight-wrapper">
















































<div aria-hidden="true" class="line-highlight" data-range="50" data-start="50">
</div></div><div class="line-highlight-wrapper">



























































<div aria-hidden="true" class="line-highlight" data-range="61" data-start="61">
</div></div><div class="line-highlight-wrapper">





































































<div aria-hidden="true" class="line-highlight" data-range="71" data-start="71">
</div></div></pre><p>El código corresponde al worker de un servidor multihilo. Analicemos ahora el código por partes</p>
<p>Es recomendable usar propiedades para guardar los mensajes que queramos comparar y tener un ENuM para definir los estados. Los <code>enum</code> en Java permiten ser usados en los bloques switch-case.</p>
<p>La propiedad <strong>estado</strong> va a ser el punto central que controle el flujo de ejecución del servidor.</p>
<pre data-role="codeBlock" data-info="java{highlight=6}" class="language-java java" data-line="6"><code><span class="token keyword keyword-private">private</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"Hi Server!"</span><span class="token punctuation">,</span> <span class="token string">"Hi Client!"</span><span class="token punctuation">,</span> <span class="token string">"Bye Server!"</span><span class="token punctuation">,</span> <span class="token string">"Error. Unknown or unexpected command"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-enum">enum</span> <span class="token class-name">Estados</span> <span class="token punctuation">{</span>
        <span class="token constant">HI</span><span class="token punctuation">,</span> <span class="token constant">BYE</span><span class="token punctuation">,</span> <span class="token constant">END</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Estados</span> estado<span class="token punctuation">;</span>
</code><div class="line-highlight-wrapper">




<div aria-hidden="true" class="line-highlight" data-range="6" data-start="6">
</div></div></pre><p>En el constructor, además de todas las propiedades, inicializamos el estado, asignándole el valor del estado inicial.</p>
<pre data-role="codeBlock" data-info="java{highlight=4}" class="language-java java" data-line="4"><code><span class="token class-name">U4A03_SaludoWorker</span><span class="token punctuation">(</span><span class="token class-name">Socket</span> socketCliente<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-this">this</span><span class="token punctuation">.</span>socketCliente <span class="token operator">=</span> socketCliente<span class="token punctuation">;</span>
    <span class="token comment">// Inicializamos el valor del estado al estado inicial</span>
    estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">HI</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre><p>El servidor estará ejecutándose hasta que se alcance el estado final</p>
<pre data-role="codeBlock" data-info="java:no-line-numbers" class="language-java:no-line-numbers java:no-line-numbers"><code>// Recibe lo que envía el cliente hasta que el mensaje sea
// END OF TRANSMISSION
while (estado != Estados.END) {
</code></pre><p>En este ejemplo, el intercambio de información con el cliente se hace uno a uno, es decir se recibe un mensaje y se envía una respuesta, pero no tiene porqué ser así, se pueden recibir varios mensajes y no enviar respuesta, o cualquier combinación de envío respuesta que nos imaginemos.</p>
<p>El código que sigue e un control para saber si el cliente ha cerrado el socket, así evitamos tener excepciones de tipo NullPointerException o dejar al servidor en un bucle infinito. Forzamos la salida cambiando el estado del protocolo.</p>
<pre data-role="codeBlock" data-info="java{highlight=4}" class="language-java java" data-line="4"><code><span class="token comment">// Comprobamos si se ha cerrado el extremo cliente del socket</span>
<span class="token comment">// Y damos por concluida la comunicación.</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>str <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">END</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Mostramos la información recibida por consola</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"CLIENTE &gt; "</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">


<div aria-hidden="true" class="line-highlight" data-range="4" data-start="4">
</div></div></pre><p>Este es el código que implementa el diagrama de estados que he diseñado para esta actividad.<br>
Fijaos que el servidor tiene que realizar una comprobación para cada línea que sale de un estado. En este caso al ser sólo dos líneas, sirve con un if-else, pero puede ser un número mayor de opciones.</p>
<p>Además, una de las opciones tiene un comportamiento totalmente diferente al resto, ya que <strong>cuando se recibe el mensaje final, el protocolo no dice que enviemos una respuesta al cliente</strong>.</p>
<p>Esto <code>debemos controlarlo en el cliente</code>, porque si lo programamos de forma que envíe un mensaje y espere una respuesta, puede quedarse bloqueado en la lectura. Aprovechando que este es el último mensaje, más adelante veremos cómo se ha solventado en el cliente.y las opciones que tenemos para evitar posibles bloqueos como este.</p>
<pre data-role="codeBlock" data-info="java{highlight=16}" class="language-java java" data-line="16"><code><span class="token comment">// Controlamos la respuesta en función del mensaje recibido y </span>
<span class="token comment">// el estado actual</span>
<span class="token keyword keyword-switch">switch</span> <span class="token punctuation">(</span>estado<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword keyword-case">case</span> <span class="token constant">HI</span><span class="token operator">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enviamos respuesta al cliente</span>
            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Cambiamos el estado del protocolo</span>
            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">BYE</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enviamos error al cliente</span>
            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-case">case</span> <span class="token constant">BYE</span><span class="token operator">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Cambiamos el estado del protocolo</span>
            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">END</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Enviamos error al cliente</span>
            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            estado <span class="token operator">=</span> <span class="token class-name">Estados</span><span class="token punctuation">.</span><span class="token constant">HI</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
    <span class="token keyword keyword-case">case</span> <span class="token constant">END</span><span class="token operator">:</span>
        <span class="token comment">// No sería necesario contemplarlo en este caso</span>
        <span class="token comment">// Pero sí en otros en los que se tenga que enviar </span>
        <span class="token comment">// algún mensaje antes de salir.</span>
        <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">














<div aria-hidden="true" class="line-highlight" data-range="16" data-start="16">
</div></div></pre><h2 id="ejemplo-de-cliente-con-estados">Ejemplo de cliente con estados </h2>
<p>Aunque un cliente interactivo como los que usamos para las pruebas no deberían cambiar su funcionalidad, sí hay que hacer pequeños ajustes para adaptar su funcionamiento a las posibles respuestas y errores que envía el servidor.</p>
<p><img src="./assets/imgs/client_sample_state_protocol.png" alt="Diagrama de estados U4A03_ProtocoloSaludo"></p>
<p>Como ya hemos dicho en el código del servidor, si implementamos el protocolo como un cliente de envío-respuesta, hay un caso en el que no debemos esperar una respuesta. Este es el caso de la salida, en la que se envía un mensaje pero no esperamos respuesta por parte del servidor.</p>
<p>Se puede pensar en poner una condición de salida para cuando el cliente envía el último mensaje, pero no podemos asegurar que ese mensaje cerrará la comunicación, porque dependerá del estado en el que se encuentre el servidor.</p>
<h3 id="ejemplo-de-cliente-genérico-que-implementa-el-protocolo">Ejemplo de cliente "genérico" que implementa el protocolo </h3>
<pre data-role="codeBlock" data-info="java{highlight=[39,41]}" class="language-java java" data-line="39,41"><code><span class="token keyword keyword-public">public</span> <span class="token keyword keyword-class">class</span> <span class="token class-name">U4A03_SaludoClient</span> <span class="token punctuation">{</span>

    <span class="token keyword keyword-private">private</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-final">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"Hi Server!"</span><span class="token punctuation">,</span> <span class="token string">"Hi Client!"</span><span class="token punctuation">,</span> <span class="token string">"Bye Server!"</span><span class="token punctuation">,</span> <span class="token string">"Error. Unknown or unexpected command"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword keyword-public">public</span> <span class="token keyword keyword-static">static</span> <span class="token keyword keyword-void">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword keyword-throws">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">Socket</span> socketCliente <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
        <span class="token class-name">BufferedReader</span> entrada <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>
        <span class="token class-name">PrintWriter</span> salida <span class="token operator">=</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">;</span>

        <span class="token comment">// Creamos un socket en el lado cliente, enlazado con un</span>
        <span class="token comment">// servidor que está en la misma máquina que el cliente</span>
        <span class="token comment">// y que escucha en el puerto 4444</span>
        <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span>
            socketCliente <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Establece canal de entrada</span>
            entrada <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-new">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>socketCliente<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Obtenemos el canal de salida</span>
            salida <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span>
                    <span class="token keyword keyword-new">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span>
                            <span class="token keyword keyword-new">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span>socketCliente<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"No puede establecer canales de E/S para la conexión"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Scanner</span> stdIn <span class="token operator">=</span> <span class="token keyword keyword-new">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> linea<span class="token punctuation">;</span>

        <span class="token comment">// El programa cliente no analiza los mensajes enviados por el</span>
        <span class="token comment">// usuario, simplemente los reenvía al servidor hasta que se envía </span>
        <span class="token comment">// el mensaje final del protocolo</span>
        <span class="token keyword keyword-do">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// Leo la entrada del usuario</span>
            linea <span class="token operator">=</span> stdIn<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// La envia al servidor por el OutputStream</span>
            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>linea<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Recibe la respuesta del servidor por el InputStream</span>
            linea <span class="token operator">=</span> entrada<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>linea <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Comprobamos si se ha cerrado el extremo servidor del socket</span>
                <span class="token comment">// Y damos por concluida la comunicación.</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// Envía a la salida estándar la respuesta del servidor</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SERVIDOR &gt; "</span> <span class="token operator">+</span> linea<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Libera recursos</span>
        salida<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stdIn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        socketCliente<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><div class="line-highlight-wrapper">





































<div aria-hidden="true" class="line-highlight" data-range="39" data-start="39">
</div></div><div class="line-highlight-wrapper">







































<div aria-hidden="true" class="line-highlight" data-range="41" data-start="41">
</div></div></pre><p>El código corresponde a un cliente interactivo genérico, que va enviando mensajes y esperando la respuesta de los mismos sin hacer ningún tipo de control sobre lo que se envía o lo que recibe.</p>
<p>Analicemos algunos aspectos del código del cliente</p>
<p>La parte que sigue es equivalente a la que hemos usado en el servidor. No modificamos el flujo envío-recepción, pero sí que comprobamos si el lado del servidor ha cerrado el socket (ha realizado todo el protocolo correctamente) para decidir que el cliente finalice su ejecución.</p>
<pre data-role="codeBlock" data-info="java{highlight=3}" class="language-java java" data-line="3"><code><span class="token comment">// Recibe la respuesta del servidor por el InputStream</span>
linea <span class="token operator">=</span> entrada<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>linea <span class="token operator">==</span> <span class="token keyword keyword-null">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Comprobamos si se ha cerrado el extremo servidor del socket</span>
    <span class="token comment">// Y damos por concluida la comunicación.</span>
    <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Envía a la salida estándar la respuesta del servidor</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SERVIDOR &gt; "</span> <span class="token operator">+</span> linea<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><div class="line-highlight-wrapper">

<div aria-hidden="true" class="line-highlight" data-range="3" data-start="3">
</div></div></pre><div class="admonition warning">
<p class="admonition-title">Lectura con timeout</p>
<p>Otra manera distinta de hacer lo mismo es usando lecturas con timeout.</p>
<p>En este ejemplo podríamos haber comprobado si el mensaje enviado es el mensaje de finalización. Es ese caso, si todo ha ido bien, no deberíamos esperar una respuesta por parte del server, pero si ha habido algún error, sí debemos realizar una lectura del socket.</p>
<p>Usando este código</p>
<pre data-role="codeBlock" data-info="java" class="language-java java"><code>        <span class="token comment">// El programa cliente no analiza los mensajes enviados por el</span>
        <span class="token comment">// usuario, simplemente los reenvía al servidor hasta que se envía </span>
        <span class="token comment">// el mensaje final del protocolo</span>
        <span class="token keyword keyword-do">do</span> <span class="token punctuation">{</span>
            <span class="token comment">// Leo la entrada del usuario</span>
            linea <span class="token operator">=</span> stdIn<span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// La envia al servidor por el OutputStream</span>
            salida<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>linea<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Si enviamos el mensaje de salida, no hacemos una lectura indefinida</span>
            <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span>linea<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>messages<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socketCliente<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span>
                socketCliente<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword keyword-try">try</span> <span class="token punctuation">{</span> 
                <span class="token comment">// Recibe la respuesta del servidor por el InputStream</span>
                linea <span class="token operator">=</span> entrada<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// Envía a la salida estándar la respuesta del servidor</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SERVIDOR &gt; "</span> <span class="token operator">+</span> linea<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword keyword-catch">catch</span> <span class="token punctuation">(</span><span class="token class-name">SocketTimeoutException</span> ste<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Pasado el timeout no se ha recibido una respuesta</span>
                <span class="token comment">// Podemos suponer que el server no envía respuesta</span>
                <span class="token comment">// Eso indica que el protocolo se ha completado</span>
                <span class="token comment">// Damos por concluida la comunicación.</span>
                <span class="token keyword keyword-break">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>            
        <span class="token punctuation">}</span> <span class="token keyword keyword-while">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>fijamos un tiempo de espera pasado el cual se producirá una <code>SocketTimeoutException</code> indicando que no se ha leído nada del socket. Si por el contrario se lee información del socket, esta se muestra por la consola.</p>
<p>En este caso en concreto, esta solución no funciona porque el servidor ya ha cerrado el socket. Esto sería útil cuando tengamos que hacer una <code>lectura opcional</code> en mitad de un protocolo, y serviría tanto para un cliente como para un servidor.</p>
</div>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>